name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
  GIT_SHA: ${{ github.sha }}
  BUILD_TIME: ${{ github.event.head_commit.timestamp }}
  HARBOR_REGISTRY: kubernetes.docker.internal:30002
  HARBOR_PROJECT: spring-cdcd
  IMAGE_NAME: my-app
  DOCKER_HOST: unix://$HOME/.docker/run/docker.sock

# ìž‘ì—… ëª©ë¡
jobs:
  test-job:
    # setting > action ì—ì„œ ì„¤ì •í•œ ëŸ¬ë„ˆë¡œ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
    runs-on: self-hosted
    steps:
      - name: ì½”ë“œ ë°›ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # ê¶Œí•œ ì˜¤ë¥˜ ë§‰ê¸° ìœ„í•œ ì„¤ì •
      - name: Gradle ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        run: |
          echo "GIT_SHA: $GIT_SHA"
          echo "BUILD_TIME $BUILD_TIME"
          echo "Current time $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test
        env:
          GIT_SHA: ${{ env.GIT_SHA }}
          BUILD_TIME: ${{ env.BUILD_TIME }}

  build-push:
    runs-on: self-hosted
    needs: test-job        # test-job ì™„ë£Œ í›„ ì‹¤í–‰
    steps:
      - name: ì½”ë“œ ë°›ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # ê¶Œí•œ ì˜¤ë¥˜ ë§‰ê¸° ìœ„í•œ ì„¤ì •
      - name: Gradle ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      # Docker ë°ëª¬ í™•ì¸ ë° ì„¤ì •
      - name: Docker ì„¤ì • ì´ˆê¸°í™”
        run: |
          echo "ðŸ”§ Docker ìƒíƒœ í™•ì¸ ë° ì„¤ì •..."

          # macOS Docker Desktop ì†Œì¼“ ê²½ë¡œ ì„¤ì •
          export DOCKER_HOST=unix://$HOME/.docker/run/docker.sock

          # Docker ë°ëª¬ ìƒíƒœ í™•ì¸
          if ! docker info >/dev/null 2>&1; then
            echo "Docker Desktopì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
            echo "DOCKER_HOST: $DOCKER_HOST"
            exit 1
          fi

          # Docker config ë””ë ‰í† ë¦¬ì™€ íŒŒì¼ ìƒì„±
          mkdir -p ~/.docker

          cat > ~/.docker/config.json << EOF
          {
            "auths": {}
          }
          EOF

          echo "âœ… Docker ì„¤ì • ì™„ë£Œ"

      - name: Harbor ë¡œê·¸ì¸
        run: |
          # Harbor ìƒíƒœ í™•ì¸
          curl -f http://${{ env.HARBOR_REGISTRY }}/api/v2.0/health || {
            echo "âŒ Harborì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          }

          # Harbor ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
          HARBOR_PASSWORD=$(kubectl get secret harbor-admin-secret -n harbor -o jsonpath='{.data.password}' | base64 -d)

          # Docker ë¡œê·¸ì¸
          echo "$HARBOR_PASSWORD" | docker login ${{ env.HARBOR_REGISTRY }} --username admin --password-stdin

          echo "âœ… Harbor ë¡œê·¸ì¸ ì„±ê³µ"

      # ì‹¤í–‰ ë‹¨ê³„ run ëª…ë ¹ì–´
      - name: ë¹Œë“œ ì‹¤í–‰
        run: ./gradlew clean build --no-daemon
        env:
          GIT_SHA: ${{ env.GIT_SHA }}
          BUILD_TIME: ${{ env.BUILD_TIME }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
          if [ "${{ github.ref_name }}" = "main" ]; then
            TAG="latest"
          else
            TAG="${{ github.ref_name }}"
          fi

          IMAGE_TAG="${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${TAG}"
          SHA_TAG="${{ env.HARBOR_REGISTRY }}/${{ env.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $IMAGE_TAG -t $SHA_TAG .

          # ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push $IMAGE_TAG
          docker push $SHA_TAG

          echo "Tags: $TAG, ${{ github.sha }}"
  
